#!/usr/bin/env node

/**
 * Generates the verification key bytes in hex format for deployment
 *
 * The VK format expected by the contract:
 * - alpha: G1 point (96 bytes uncompressed)
 * - beta: G2 point (192 bytes uncompressed)
 * - gamma: G2 point (192 bytes uncompressed)
 * - delta: G2 point (192 bytes uncompressed)
 * - ic_len: u32 big-endian (4 bytes)
 * - ic[0..n]: G1 points (96 bytes each)
 *
 * Note: These are the TEST values from test.rs
 * For production, you need BLS12-381 compatible proving keys
 */

const { execSync } = require('child_process');

// BLS12-381 field element to 48-byte big-endian
function fqToBytes(decimalStr) {
  let n = BigInt(decimalStr);
  const bytes = [];
  for (let i = 0; i < 48; i++) {
    bytes.unshift(Number(n & 0xFFn));
    n >>= 8n;
  }
  return Buffer.from(bytes);
}

// G1 point (x, y) to 96 bytes uncompressed
// BLS12-381 uncompressed format: x (48 bytes BE) + y (48 bytes BE)
function g1ToBytes(x, y) {
  const xBytes = fqToBytes(x);
  const yBytes = fqToBytes(y);
  return Buffer.concat([xBytes, yBytes]);
}

// G2 point (x1, x2, y1, y2) to 192 bytes uncompressed
// BLS12-381 G2 uses Fq2 which has two components
// Format: x.c0 (48) + x.c1 (48) + y.c0 (48) + y.c1 (48)
function g2ToBytes(x1, x2, y1, y2) {
  const x1Bytes = fqToBytes(x1);
  const x2Bytes = fqToBytes(x2);
  const y1Bytes = fqToBytes(y1);
  const y2Bytes = fqToBytes(y2);
  return Buffer.concat([x1Bytes, x2Bytes, y1Bytes, y2Bytes]);
}

// VK values from test.rs (BLS12-381)
const vk = {
  alpha: {
    x: "2625583050305146829700663917277485398332586266229739236073977691599912239208704058548731458555934906273399977862822",
    y: "1155364156944807367912876641032696519500054551629402873339575774959620483194368919563799050765095981406853619398751"
  },
  beta: {
    x1: "1659696755509039809248937927616726274238080235224171061036366585278216098417245587200210264410333778948851576160490",
    x2: "1338363397031837211155983756179787835339490797745307535810204658838394402900152502268197396587061400659003281046656",
    y1: "1974652615426136516341494326987376616840373177388374023461177997087381634383568759591087499459321812809521924259354",
    y2: "3301884318087924474550898163462840036865878131635519297186391370517333773367262804074867347346141727012544462046142"
  },
  gamma: {
    x1: "352701069587466618187139116011060144890029952792775240219908644239793785735715026873347600343865175952761926303160",
    x2: "3059144344244213709971259814753781636986470325476647558659373206291635324768958432433509563104347017837885763365758",
    y1: "1985150602287291935568054521177171638300868978215655730859378665066344726373823718423869104263333984641494340347905",
    y2: "927553665492332455747201965776037880757740193453592970025027978793976877002675564980949289727957565575433344219582"
  },
  delta: {
    x1: "2750191744467054372912942146482544263484467550244832445881626112777617723646810063952263428512022936903253267127350",
    x2: "2413234737575312815700598631122026291319065432043412800839944397857332202830802685415923770088689063622756702939375",
    y1: "1076967202486993406108941342102174843689250913208763125383730107292668137282535239225119066564005251774661400843821",
    y2: "784091089348445241891924627629031628871298938526420228496183038286414003726447208549611976928427786617444752683904"
  },
  ic: [
    {
      x: "1931769351244036379618100283994844046485312882458040431401676712058257124546097756332532237907637132315648906217636",
      y: "2219462221684288788247757134332962645470083865115055927456187574960992952094314940257753501443104606354496083113203"
    },
    {
      x: "2726325242623221693388802248110816107554759305800882344642286106642968529507795071709947858512355148550879270019178",
      y: "2690452834591447292232392438454117662004701691035040250634864436657178120453111433393322306334324558619029220405511"
    },
    {
      x: "2276753520377413052133204619264853734926027674320220733263964937413806530791610300908525130874383991218501161443629",
      y: "2216565042994647061456742959690979278824752277479734731836503122505090074006677407948960110633236603228440758211011"
    },
    {
      x: "2054702829658916052030239062784122350883101497414801284378548048954817335805733517964277882891682327579038641542963",
      y: "1861299377849520465661244108949779781960526739720579329803172490216038156998919390163110860296739149427635782605232"
    },
    {
      x: "2856004998221708121377069305149495649378668245327503671752831152976814973551962498318427356938380464598719642329610",
      y: "3445052445376607662168014620609501339582857414982758608624858423598446194176241135586201569345644453045853894315946"
    }
  ]
};

// Build the VK bytes
const parts = [];

// Alpha (G1 - 96 bytes)
parts.push(g1ToBytes(vk.alpha.x, vk.alpha.y));

// Beta (G2 - 192 bytes)
parts.push(g2ToBytes(vk.beta.x1, vk.beta.x2, vk.beta.y1, vk.beta.y2));

// Gamma (G2 - 192 bytes)
parts.push(g2ToBytes(vk.gamma.x1, vk.gamma.x2, vk.gamma.y1, vk.gamma.y2));

// Delta (G2 - 192 bytes)
parts.push(g2ToBytes(vk.delta.x1, vk.delta.x2, vk.delta.y1, vk.delta.y2));

// IC length (4 bytes big-endian)
const icLenBuf = Buffer.alloc(4);
icLenBuf.writeUInt32BE(vk.ic.length);
parts.push(icLenBuf);

// IC points (96 bytes each)
for (const ic of vk.ic) {
  parts.push(g1ToBytes(ic.x, ic.y));
}

const vkBytes = Buffer.concat(parts);
const vkHex = vkBytes.toString('hex');

console.log('VK Bytes (hex):');
console.log(vkHex);
console.log('');
console.log('Total size:', vkBytes.length, 'bytes');
console.log('');
console.log('Expected size breakdown:');
console.log('  Alpha (G1): 96 bytes');
console.log('  Beta (G2): 192 bytes');
console.log('  Gamma (G2): 192 bytes');
console.log('  Delta (G2): 192 bytes');
console.log('  IC length: 4 bytes');
console.log('  IC points (5 x 96): 480 bytes');
console.log('  Total: 1156 bytes');
